<div class="wrap-content">
  <div class="module module-white min-height">
    <div class="module-tab0 module-tab2">
      <ul id="myTab" class="nav nav-tabs">
        <li class="active"><a href="#gift_cards">礼品卡</a></li>
        <li class=""><a href="#combos">商品搭配</a></li>
      </ul>

      <div class="tab-content">
        <div id="gift_cards" class="tab-pane active">
          <div class="module-table-box module-record">
            <%= render "gift_card_list", gift_cards: @gift_cards %>
          </div>
        </div>
        <div id="combos" class="tab-pane">
          <div class="module-table-box module-record">
          <% @combos.each do |combo| %>
            <div class="module common-white">
              <div class="txt-block detail-contact">
                  <div class="row-fluid">
                    <div class="span3"><%= image_tag "/images/1.jpg" %></div>
                    <div class="span9 collection-p">
                      <p class="txt2"><%= link_to combo["desc"], new_ims_store_combo_path(combo["id"]) %></p>
                      <p class="txt2 txt-red"><span class="txt-grey">组合价：</span>￥<%= combo["price"] %></p>
                      <%= link_to combo["is_online"] ? "下架" : "上架", "javascript:void(0);", class: "card_or_combo", item_id: combo["id"], item_type: 2 %>
                    </div>
                  </div>
              </div>
            </div>
          <% end %>
          <%= link_to '添加搭配商品', new_ims_store_combo_path %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%= hidden_field_tag "gift_card_count", @search_gift_card[:data][:totalcount] %>
<%= hidden_field_tag "gift_card_page", @search_gift_card[:data][:pageindex] %>
<%= hidden_field_tag "gift_card_per_page", @search_gift_card[:data][:pagesize] %>


<% content_for :javascripts do %>
<script>
  $(function(){

    $(window).scroll(function(){
      var htmlHeight=document.body.scrollHeight
      var clientHeight=document.body.clientHeight
      var scrollTop=document.body.scrollTop

      console.info(htmlHeight)
      console.info(clientHeight)
      console.info(scrollTop)
      console.info($("#gift_cards").attr("class").indexOf("active"))

      if(scrollTop+clientHeight == htmlHeight){
        var count = parseInt($("#gift_card_count").attr("value"))
        var page = parseInt($("#gift_card_page").attr("value"))
        var per_page = parseInt($("#gift_card_per_page").attr("value"))

        if($("#gift_cards").attr("class").indexOf("active") >= 0){
          if(page * per_page < count){
            $.get("/ims/store/sells", {page: page + 1, per_page: per_page}, function(data){
              if(data["status"] == true){
                $(".gift_card_paginate-content:last").after(data["html"])
                $("#gift_card_count").attr("value", data["count"])
                $("#gift_card_page").attr("value", data["page"])
                $("#gift_card_per_page").attr("value", data["per_page"])
              }
            }, "json")
          }
        }

      }




    })

    $('#myTab a').click(function (e) {
      e.preventDefault()
      $(this).tab('show')
    })

    $(document).on("click", ".card_or_combo", function(){
      this_ele = $(this)
      store_id = "store_id"
      item_id = this_ele.attr("item_id")
      item_type = this_ele.attr("item_type")
      text = this_ele.text()
      is_online = text == "上架" ? true : false
      $.post("/ims/store/sells/id/update_is_online", {_method: "put", store_id: store_id, item_id: item_id, item_type: item_type, is_online: is_online}, function(data){
        if(data["status"]){
          this_ele.text(is_online ? "下架" : "下架")
        }else{
          alert(text+"失败")
        }
      })
    })

  })
</script>
<% end %>


