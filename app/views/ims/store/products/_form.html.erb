<br/>
<div class="wrap-inner back-wrap-inner">
<div class="module module-bg-white2">

  <div class="module-title2">
    <div class="row-fluid">
      <div class="span6">
      <h3><i class="fa fa-heart"></i>商品图片</h3>
      </div>
      <div class="span6">
          <div class="text-right">
            <%#= link_to_icon "fa fa-angle-right", "上传教程", tutorials_ims_store_products_path, class: "title-link" %>
          </div>
      </div>
    </div>
  </div>

  <% images = @product.try(:[], :images) || [] %>

    <div class="module-pull">
       <div class="row-fluid">
           <div class="span2">&nbsp;</div>
           <div class="span8">
              <div class="<%= images.present? ? 'show-imgbox-yes' : 'show-imgbox-no' %>" id="default_img"><!-- 没有上传图片时class="show-imgbox-no" ;有上传后的图片时class="show-imgbox-yes" -->
                <% if images.present? %>
                  <img src="<%= images.last[:url] %>">
                <% else %>
                  <%= image_tag 'ims/no-image.jpg' %>
                <% end %>
              </div>
           </div>
           <div class="span2">&nbsp;</div>
       </div>
    </div>
    <div class="mini-imgbox">
        <ul class="inline clearfix" id="img_box">
          <% images.each do |image| %>
            <li>
              <i id="img_<%= image[:id] -%>" data="<%= image[:id] -%>"><%= image_tag 'ims/delate.png' %></i>
              <span class="img-spa">
                <img src="<%= image[:url] %>" >
              </span>
            </li>
          <% end %>
          <% if images.size < 5 %>
            <li class="add-link" id="add_img">
              <span class="img-spa"><%= image_tag "ims/add-img.png" %></span>
            </li>
          <% end %>
          <div style="height: 0px;width: 0px; overflow:hidden;">
            <input id="upfile" type="file" value="upload" name="img" accept="image/*" capture="camera">
          </div>
        </ul>
    </div>


  <% if nil %>
  <div class="module-pull module-uploadimg">
     <div class="row-fluid">
         <div class="span8">
            <div id="result" class="show-imgbox-no"><!-- 没有上传图片时class="show-imgbox-no" ;有上传后的图片时class="show-imgbox-yes" -->
              <% if @product.blank? %>
                <%= image_tag "ims/upload-image.jpg", alt: "img-name", id: "img" %>
              <% else %>
                <img src="<%=@product[:image]%>" alt="img-name" id="img" />
              <% end %>
              <!-- 400px * 400px 没有上传图片时显示默认图片no-image.jpg-->
            </div>
            <span id="img_error_notice"></span>
         </div>
         <div class="span4">
           <%= link_to_icon "fa fa-hand-o-left", "点击更换图片", "javascript:void(0);", class: "title-link", id: "upload_img_link" %>
         </div>
     </div>
  </div>
  <% end %>
</div>



<%= form_tag url, method: method, multipart: true, id: "product_form", class: "form-defined" do %>
<div class="module module-bg-white2">
    <div class="form-box">


        <%= hidden_field_tag "is_create_combo", request.referer.blank? ? "1" : nil %>
        <div style="height: 0px;width: 0px; overflow:hidden;">
          <%= file_field_tag "image", id: "input", accept: "image/*", capture: "camera" %>
        </div>
        <%= hidden_field_tag "id", @product.try(:[], :id) %>
        <% if (image_ids = @product.try(:[], :image_ids)).present? %>
          <% image_ids.each do |image_id| %>
            <%= hidden_field_tag "image_ids[]", image_id %>
          <% end %>
        <% end %>
        <% if @combo_id.present? %>
          <%= hidden_field_tag :combo_id, @combo_id %>
        <% end %>
          <div class="controls-defined defined-small">
              <label class="col-4 text-left"><abbr class="txt-red">*</abbr>品牌：</label>
              <div class="col-8">
                  <%= select_tag "brand_id", options_for_select(@brands.collect{|obj| [obj["name"], obj["id"]]}, @product.try(:[], :brand_id)), prompt: "请选择" %>
              </div>
          </div>
          <div class="controls-defined defined-small">
              <label class="col-4 text-left"><abbr class="txt-red">*</abbr>销售编码：</label>
              <div class="col-5">
                  <%= select_tag "sales_code", options_for_select(@codings, @product.try(:[], :sales_code)), prompt: "请选择" %>
              </div>
              <div class="col-3 text-center">
              <span>
              <%= link_to "添加", "#new_coding_form", "data-toggle" => "modal", class: "txt8 newly" %>
              </span>
              </div>
          </div>
          <div class="controls-defined defined-small">
              <label class="col-4 text-left"><abbr class="txt-red">*</abbr>货号：</label>
              <div class="col-8">
                <%= text_field_tag "sku_code", @product.try(:[], :sku_code) %>

              </div>
          </div>

          <div class="controls-defined defined-small">
              <label class="col-4 text-left"><abbr class="txt-red">*</abbr>原价：</label>
              <div class="col-8">
              <%= text_field_tag "unitprice", @product.try(:[], :unitprice) %>
              </div>
          </div>

          <div class="controls-defined defined-small">
              <label class="col-4 text-left"><abbr class="txt-red">*</abbr>微信价：</label>
              <div class="col-8">
              <%= text_field_tag "price", @product.try(:[], :price) %>
              </div>
          </div>

          <div class="controls-defined defined-small">
              <label class="col-4 text-left"><abbr class="txt-red">*</abbr>颜色：</label>
              <div class="col-8">
              <%= text_field_tag "color_str", params[:action] == "new" ? "均色" : @product.try(:[], :color_str) %>
              </div>
          </div>

          <div class="controls-defined defined-small">
              <label class="col-4 text-left"><abbr class="txt-red">*</abbr>分类：</label>
              <div class="col-8">
              <%= select_tag "category_id", options_for_select(@categories.collect{|obj| [obj["name"], obj["id"]]}, @product.try(:[], :category_id)), prompt: "请选择" %>
              </div>
          </div>


    </div>
</div>

<div class="module module-bg-white2">

    <div class="module-title2">
      <div class="row-fluid">
        <div class="span4"></div>
        <div class="span8">
          <div class="text-right"><small><i class="fa fa-exclamation-circle"></i> 至少填写一项尺码和库存</small></div>
        </div>
      </div>
    </div>

    <% if params[:action] == "new" %>
      <%= render "size", size: nil, action: "add" %>
    <% else %>
      <% @product.try(:[], :sizes).each_with_index do |size, index| %>
        <%= render "size", size: size, action: index.zero? ? "add" : "remove" %>
      <% end %>
    <% end %>

</div>

<div class="module module-bg-white2">
    <div class="module-title2">
        <div class="row-fluid">
            <div class="span4"><h3><i class="fa fa-pencil-square-o"></i>产品描述</h3></div>
            <div class="span8">
                <div class="text-right"><small><i class="fa fa-exclamation-circle"></i> 支持最多128个字符</small></div>
            </div>
        </div>
    </div>
    <div class="goods-describe">
      <%= text_area_tag "desc", @product.try(:[], :desc), rows: 4 %>
    </div>
</div>

<% end %>


<div class="bottom-btnbox">
  <button class="btn btn-small btn-danger" id="submit_product">提交</button>
</div>


<div id="new_coding_form" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">销售编码 添加：</h3>
  </div>
  <div class="modal-body">

    <form class="form-defined">
    <div class="controls-defined defined-small">
        <label class="col-3 text-right">销售编码</label>
        <div class="col-8"><%= text_field_tag "coding", nil %></div>
      </div>
    </form>

  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
    <button class="btn btn-primary" id="coding_button" data-dismiss='modal' aria-hidden='true'>保存</button>
  </div>
</div>
</div>



<%= content_for :javascripts do -%>
<script type="text/javascript">
  $(function(){

    document.getElementById('input').onchange = function (e) {
      $("#loading-box").modal();
      var orientation ;
      loadImage.parseMetaData(
        e.target.files[0],
        function(data){
          if(data.exif)
          orientation = data.exif.get('Orientation');
        }
      );

      loadImage(
        e.target.files[0],
        function(img){
          var resized = resizeIos(img, 640, 640, orientation);
          $.ajax({
            url: "/ims/store/products/upload",
            dataType: 'json',
            type: 'post',
            data: {"img": resized},
            beforeSend: function(){
              $("#add_img").hide();
            },
            success: function(data){
              $("#loading-box").modal('hide');
              if(data['status'] == 1){
                setTimeout(function(){
                  <% if nil %>
                   $("#image_id").attr("value", data["id"])
                   img = "<img src='"+data["img_url"]+"'/>"
                   $("#result").html(img)
                   format_img("#result")
                  <% end %>
                  hidden_image_field = '<input type="hidden" value="'+data["id"]+'" name="image_ids[]">'
                  insert_html = "<li><i id='img_"+data['id']+"' data='"+data['id']+"'><img src='/assets/ims/delate.png'></i><span class='img-spa'><img src='"+data['img_url']+"'></span></li>";
                  if($("#img_box li[class!='add-link']").length >0 ){
                    $($("#img_box li[class!='add-link']:last")).after(insert_html);
                  }else{
                    $("#img_box").prepend(insert_html);
                  };
                  $("#product_form").append(hidden_image_field)

                  $("#default_img").addClass("show-imgbox-yes");
                  $("#default_img").removeClass("show-imgbox-no");
                  $("#default_img").html("<img src='"+data['img_url']+"'>");
                  img_size = $("#img_box li[class!='add-link']").length;
                  if(img_size == 5){
                    $("#add_img").hide();
                  }else{
                    $("#add_img").show();
                  }
                  format_img(".show-imgbox-no");
                  format_img(".img-spa");
                  format_img(".show-imgbox-yes");

                 }, 800);
               }else{
                 error_modal("网络错误，请稍后重试");
               }
            },
            error: function(data){
              $("#loading-box").modal('hide');
              $("#add_img").show();
              error_modal("上传发生错误，请稍后重试");
            }
          });
        }
      )
    };

    $(document).on("click", "#img_box li i", function(){
      if(confirm("确定要删除该图片？")){
        mid = $(this).attr("data")
        $("#img_"+mid).parent().remove()
        $("input[name='image_ids[]'][value="+mid+"]").remove()
        img_size = $("#img_box li[class!='add-link']").length
        if(img_size < 5 && img_size > 0){
          $("#add_img").show()
          $("#default_img").html("<img src='"+$("#img_box li[class!='add-link'] span img")[0].src+"'>")
        }else{
          $("#add_img").show()
          $("#default_img").html('<%= image_tag "ims/no-image.jpg" %>')
        }
        format_img(".show-imgbox-no")
        format_img(".img-spa")
        format_img(".show-imgbox-yes")

      }

    })


    $("#submit_product").click(function(){

      is_blank_size_name = $.inArray('', $("input[name='sizes[][name]']").map(function(){
        return $(this).val()
      }).get()) == -1

      is_blank_size_inventory = $.inArray('', $("input[name='sizes[][inventory]']").map(function(){
        return $(this).val()
      }).get()) == -1


      if($("#product_form").valid()){

        if( is_blank_size_name && is_blank_size_inventory){
          $("#loading-box").modal();
          $("#product_form").submit();
        }else{
          error_modal("尺码和库存必填")
        }
      }
    });


    $("#input").on("change", function(){
      if($(this).val().length != ""){
        $("#img_error_notice").html('')
      }
    })


    $("#coding_button").on("click", function(){
      coding = $("#coding").val()
      if(coding.length > 0){
        $.post("/ims/store/sales_codes", {coding: coding}, function(data){
          if(data["status"] == true){
            $("#sales_code").html("")
            $.each(data["data"], function(index, value){
              $("#sales_code").append("<option value='"+value+"'>"+value+"</option>")
            })
            $("#sales_code option:last").attr("selected", true)
          }else{
            error_modal("销售编码添加失败")
          }
        }, "json")
      }else{
        error_modal("销售编码不能为空")
      }
    })

    $("#product_form").validate({
      onsubmit: true,
      onfocusout: false,
      onkeyup: false,
      onclick: false,
      rules: {
        <% if params[:action] == "new" %>
        "image": {
          required: true
        },
        <% end %>
        "brand_id": {
          required: true
        },
        "sales_code": {
          required: true
        },
        "sku_code": {
          required: true,
          minlength: 2,
          maxlength: 50
        },
        "price": {
          required: true,
          number: true
        },
        "unitprice": {
          required: true,
          number: true,
          more_than: "#price"
        },
        "category_id": {
          required: true
        },
        "color_str": {
          required: true
        },
        "desc": {
          maxlength: 128
        },
        "sizes[][inventory]": {
          min: 1
        },
        "sizes[][name]": {
          required: true
        }
      },
      messages: {
        <% if params[:action] == "new" %>
        "image": {
          required: "图片不能为空"
        },
        <% end %>
        "brand_id": {
          required: "品牌不能为空"
        },
        "sales_code": {
          required: "销售编码不能为空"
        },
        "sku_code": {
          required: "货号不能为空",
          minlength: "货号长度至少2",
          maxlength: "货号长度最多50"
        },
        "price": {
          required: "微信价不能为空",
          number: "微信价只能是数字"
        },
        "unitprice": {
          required: "原价不能为空",
          number: "原价只能是数字",
          more_than: "微信价不能大于原价"
        },
        "category_id": {
          required: "分类不能为空"
        },
        "color_str": {
          required: "颜色不能为空"
        },
        "desc": {
          maxlength: "描述最多128个字符"
        },
        "sizes[][inventory]": {
          min: "库存至少为1"
        },
        "sizes[][name]": {
          required: "尺码不能为空"
        }
      },
      showErrors: function(errorMap, errorList) {
        var messages = errorList.map(function(i, v) {
          return i.message
        })
        msg = messages.join(", ")
        if(msg != ""){
          error_modal(msg);
        }
      },
      errorPlacement:function(error, element){
        if(element.attr("id") == "input"){
          $("#img_error_notice").html(error)
        }else{
          element.after(error)
        }
      }


    })

    var result = document.getElementById("result");
    var input = document.getElementById("input");

    $(document).on("click", "#result, #upload_img_link", function(){
      $("#input").trigger("click")
    })

    $(".add_size").on("click", function(){
      $.get("/ims/store/products/add_size", {}, function(data){
        $(".size_input:last").after(data["html"])
      }, "json")
    })

    $(document).on("click", ".remove_size", function(){
      $(this).parents(".size_input").remove()
    })


    <% if params[:action] == "new" %>
      $("#category_id").trigger("change")
    <% end %>

    $("#add_img").click(function(){
       img_size = $("#img_box li[class!='add-link']").length
       if(img_size < 5){
         document.getElementById("input").click()
       }else{
        error_modal("上传商品图片不能超过5个")
       }
    })


  })
</script>
<% end %>