<br/>
<div class="wrap-inner back-wrap-inner">
<div class="module module-bg-white2">
  <div class="module-title2">
    <div class="row-fluid">
      <div class="span6"><h3>上传图片</h3></div>
      <div class="span6">
          <div class="text-right">
            <%#= link_to_icon "fa fa-angle-right", "上传教程", tutorials_ims_store_products_path, class: "title-link" %>
          </div>
      </div>
    </div>
  </div>
  <div class="module-pull module-uploadimg">
     <div class="row-fluid">
         <div class="span8">
            <div id="result" class="show-imgbox-no"><!-- 没有上传图片时class="show-imgbox-no" ;有上传后的图片时class="show-imgbox-yes" -->
              <% if @product.blank? %>
                <%= image_tag "/images/ims/upload-image.jpg", alt: "img-name", id: "img" %>
              <% else %>
                <%= image_tag @product[:image], alt: "img-name", id: "img" %>
              <% end %>
              <!-- 400px * 400px 没有上传图片时显示默认图片no-image.jpg-->
            </div>
            <span id="img_error_notice"></span>
         </div>
         <div class="span4">
           <%= link_to_icon "fa fa-hand-o-left", "点击更换图片", "javascript:void(0);", class: "title-link", id: "upload_img_link" %>
         </div>
     </div>
  </div>
</div>

<div class="module module-bg-white2">
    <div class="form-box">

      <%= form_tag url, method: method, multipart: true, id: "product_form", class: "form-defined" do %>

        <div style="height: 0px;width: 0px; overflow:hidden;">
          <%= file_field_tag "image", id: "input", accept: "image/*" %>
        </div>
        <%= hidden_field_tag "id", @product.try(:[], :id) %>
        <% if @combo_id.present? %>
          <%= hidden_field_tag :combo_id, @combo_id %>
        <% end %>
          <div class="controls-defined defined-small">
              <label class="col-4 text-left"><abbr class="txt-red">*</abbr>品牌：</label>
              <div class="col-8">
                  <%= select_tag "brand_id", options_for_select(@brands.collect{|obj| [obj["name"], obj["id"]]}, @product.try(:[], :brand_id)), prompt: "请选择" %>
              </div>
          </div>
          <div class="controls-defined defined-small">
              <label class="col-4 text-left"><abbr class="txt-red">*</abbr>销售编码：</label>
              <div class="col-5">
                  <%= select_tag "coding_id", options_for_select(@codings, @product.try(:[], :sales_code)), prompt: "请选择" %>
              </div>
              <div class="col-3 text-center">
              <span>
              <%= link_to "添加", "#new_coding_form", "data-toggle" => "modal", class: "txt8 newly" %>
              </span>
              </div>
          </div>
          <div class="controls-defined defined-small">
              <label class="col-4 text-left"><abbr class="txt-red">*</abbr>货号：</label>
              <div class="col-8">
                <%= text_field_tag "sku_code", @product.try(:[], :sku_code) %>

              </div>
          </div>

          <div class="controls-defined defined-small">
              <label class="col-4 text-left"><abbr class="txt-red">*</abbr>微信价：</label>
              <div class="col-8">
              <%= text_field_tag "price", @product.try(:[], :price) %>
              </div>
          </div>

          <div class="controls-defined defined-small">
              <label class="col-4 text-left"><abbr class="txt-red">*</abbr>分类：</label>
              <div class="col-8">
              <%= select_tag "category_id", options_for_select(@categories.collect{|obj| [obj["name"], obj["id"]]}, @product.try(:[], :category_id)), prompt: "请选择" %>
              </div>
          </div>

          <div id="loading" class="text-center" style="display: none;">
            <img src='/images/ims/loading.gif'/>
          </div>

          <div class="controls-defined defined-small" id="size_ids_wrapper" style="<%= @product.try(:[], :size_type) == 1 ? 'display: inline;' : 'display: none;' %>">
            <label class="col-4 text-right"><abbr class="txt-red">*</abbr>尺码：</label>
            <div class="col-8">
              <span class="goods-size">
                  <% @sizes.each do |size| %>
                    <% if @product[:size].collect{|obj| obj[:size_id]}.include?(size.id) %>
                      <%= hidden_field_tag "size_ids[]", size.id %>
                      <%= link_to size.name, "javascript:void(0);", value: size.id, class: "active" %>
                    <% else %>
                      <%= link_to size.name, "javascript:void(0);", value: size.id %>
                    <% end %>
                  <% end if @sizes.present? && @sizes.is_a?(Array) %>
              </span>
            </div>
          </div>


          <div class="controls-defined defined-small" id="size_str_wrapper" style="<%= @product.try(:[], :size_type) == 2 ? 'display: line;' : 'display: none;' %>">
              <label class="col-4 text-left"><abbr class="txt-red">*</abbr>规格：</label>
              <div class="col-8">
              <%= text_field_tag "size_str", @product.try(:[], :size_str), class: "form-textframe" %>
              </div>
          </div>



          <div class="block-box">
              <button type="submit" class="btn btn-danger btn-large btn-block">提交</button>
          </div>
      <% end %>
    </div>
</div>


<div id="new_coding_form" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">销售编码 添加：</h3>
  </div>
  <div class="modal-body">
  <div class="control-group">
    <label class="control-label">销售编码:</label>
    <div class="controls">
    <%= text_field_tag "coding", nil %>
    </div>
  </div>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
    <button class="btn btn-primary" id="coding_button">保存</button>
  </div>
</div>
</div>


<%= content_for :javascripts do -%>
<script type="text/javascript">
  $(function(){

    $("#product_form").on("submit", function(){
      error = '<span class="error">不能为空</span>'
      if(!$("#size_ids_wrapper").is(":hidden")){
        if($("input[name='size_ids[]']").length == 0){
          if($("#size_ids_wrapper .error").length == 0){
            $("#size_ids_wrapper .goods-size").after(error)
          }
          return false
        }else{
          $("#size_ids_wrapper .error").remove()
        }
      }
    })

    $("#input").on("change", function(){
      if($(this).val().length != ""){
        $("#img_error_notice").html('')
      }
    })


    $("#coding_button").on("click", function(){
      coding = $("#coding").val()
      if(coding.length > 0){
        $.post("/ims/store/sales_codes", {coding: coding}, function(data){
          if(data["status"] == true){
            $("#new_coding_form").modal("hide")
            $("#coding_id").html("")
            $.each(data["data"], function(index, value){
              $("#coding_id").append("<option value='"+value+"'>"+value+"</option>")
            })
            $("#coding_id option:last").attr("selected", true)
          }else{
            alert("销售编码添加失败")
          }
        }, "json")
      }else{
        alert("销售编码不能为空")
      }
    })

    $("#product_form").validate({
      ignore: "",
      rules: {
        <% if params[:action] == "new" %>
        "image": {
          required: true
        },
        <% end %>
        "brand_id": {
          required: true
        },
        "coding_id": {
          required: true
        },
        "sku_code": {
          required: true
        },
        "price": {
          required: true,
          number: true
        },
        "category_id": {
          required: true
        },
        "size_ids": {
          required: true
        }
      },
      errorPlacement:function(error, element){
        if(element.attr("id") == "input"){
          $("#img_error_notice").html(error)
        }else{
          element.after(error)
        }
      }

    })

    var result = document.getElementById("result");
    var input = document.getElementById("input");

    if(typeof FileReader==='undefined'){
      result.innerHTML = "抱歉，你的浏览器不支持 FileReader";
      input.setAttribute('disabled','disabled');
    }else{
      input.addEventListener('change',readFile,false);
    }

    $(document).on("click", "#result, #upload_img_link", function(){
      $("#input").trigger("click")
    })

    $("#category_id").on("change", function(){
      category_id = $(this).val()
      if(category_id.length == 0){
        $("#size_ids_wrapper").hide()
        $("#size_str_wrapper").hide()
      }else{

        $("#loading").show()
        $.get("/ims/store/dicts/product_sizes", {category_id: category_id}, function(data){
          if(data["size_type"] == 1){
            $("#size_ids_wrapper").show()
            $("#size_str_wrapper").hide()
            $("#size_ids_wrapper .goods-size").html("")
            $.each(data["data"], function(index, value){
              link = '<a href="javascript:void(0);" value="'+value.id+'">'+value.name+'</a>'
              $("#size_ids_wrapper .goods-size").append(link)
              // $("#size_ids").append("<option value='"+value.id+"'>"+value.name+"</option>")
            })
          }else{
            $("#size_ids_wrapper").hide()
            $("#size_str_wrapper").show()
          }
          $("#loading").hide()
        }, "json")
      }
    })

    $(document).on("click", "#size_ids_wrapper .goods-size a", function(){
      class_name = $(this).attr("class") || ""
      size_id = $(this).attr("value")
      error = '<span class="error">不能为空</span>'
      if(class_name.indexOf('active') >= 0){
        $(this).removeClass("active")
        $("input[name='size_ids[]'][value='"+size_id+"']").remove()
        if($("input[name='size_ids[]']").length == 0){
          $("#size_ids_wrapper .goods-size").after(error)
        }
      }else{
        $(this).addClass("active")
        $(this).after('<input type="hidden" value="'+size_id+'" name="size_ids[]">')
        $("#size_ids_wrapper .error").remove()
      }
    })

    <% if params[:action] == "new" %>
      $("#category_id").trigger("change")
    <% end %>

    function readFile(){
      var file = this.files[0];
      if(!/image\/\w+/.test(file.type)){
        alert("文件必须为图片！");
        return false;
      }
      var reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = function(e){
        result.innerHTML = '<img src="'+this.result+'"/>'
      }
    }

  })
</script>
<% end %>