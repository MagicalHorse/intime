<%= form_for [:ims, :store, @combo] do |f| %>
<div class="module module-bg-white">
    <div class="module-title2">
        <div class="row-fluid">
            <div class="span6"><h3><i class="fa fa-heart"></i>搭配组合照</h3></div>
            <div class="span6">
                <div class="text-right">
                  <%= link_to '商品搭配教程<i class="fa fa-angle-right"></i>'.html_safe, tutorials_ims_store_combos_path %>
                </div>
            </div>
        </div>
    </div>
    <div class="module-pull">
       <div class="row-fluid">
           <div class="span2">&nbsp;</div>
           <div class="span8">
               <div class="<%= @combo.combo_pics.present? ? 'show-imgbox-yes' : 'show-imgbox-no' %>" id="default_img"><!-- 没有上传图片时class="show-imgbox-no" ;有上传后的图片时class="show-imgbox-yes" -->
                 <% if @combo.combo_pics.present? %>
                   <img src="<%= @combo.combo_pics.last.url %>">
                 <% else %>
                   <img src="/images/ims/no-image.jpg" alt="img-name"><!-- 400px * 400px 没有上传图片时显示默认图片no-image.jpg-->
                 <% end %>
               </div>
           </div>
           <div class="span2">&nbsp;</div>
       </div>
    </div>
    <div class="mini-imgbox">
        <ul class="inline" id="img_box">
            <% @combo.combo_pics.each do |pic| %>
            <li><i id="img_<%= pic.id -%>" data="<%= pic.id -%>"></i><img src='<%= pic.url -%>'></li>
            <% end %>
            <li class="add-link"><a href="#" id="add_img"><img src="/images/ims/add-img.png"></a></li>
            <div style="height: 0px;width: 0px; overflow:hidden;"><input id="upfile" type="file" value="upload" name="img"></div>
        </ul>
    </div>
</div>


<div class="module module-bg-white">
    <div class="module-title2">
        <div class="row-fluid">
            <div class="span12"><h3><i class="fa fa-heart"></i>搭配商品上传</h3></div>
        </div>
    </div>
    <div class="upload-img">
        <ul class="inline" id="p_box">
          <% @combo.combo_products.each do |product| %>
            <li><i id="p_<%=product.id%>" data="<%=product.id%>"></i><img src="<%= product.img_url %>"></li>
          <% end %>
          <li class="add-link"><a href="javascript:void(0);" id="add_product"><img src="/images/ims/add-img.png"></a></li>
        </ul>
    </div>
</div>

<div class="module module-bg-white">
    <div class="module-title2">
        <div class="row-fluid">
            <div class="span4"><h3><i class="fa fa-pencil-square-o"></i>搭配描述</h3></div>
            <div class="span8">
                <div class="text-right"><small><i class="fa fa-exclamation-circle"></i> 支持最多128，最少20个字符</small></div>
            </div>
        </div>
    </div>
    <div class="goods-describe">
      <%= f.text_area :desc, :rows => 2 %>
    </div>
</div>

<div class="module module-bg-white">
    <div class="module-title2">
        <div class="row-fluid">
            <div class="span12"><h3><i class="fa fa-user"></i>定制对象</h3></div>
        </div>
    </div>
    <div class="module-formbox">
      <%= f.text_field :private_to, class: 'input-small' %>
      <span class="help-inline help-inlinetext">顾客姓名或昵称</span>
    </div>
</div>

<% if @remote_id.present? %>
  <%= f.hidden_field :remote_id, @remote_id %>
<% end %>
<div class="bottom-btnbox">
    <button class="btn btn-large btn-danger"><i class="fa fa-eye"></i>预 览</button>
    <button class="btn btn-large btn-danger" type="submit"><i class="fa fa-upload"></i>提交发布</button>
</div>
<% end %>

<div class="popup-menu-box">
  <div class="popup-menu" style="display:none;" id="pop-menu">
    <%= link_to "新拍商品", new_ims_store_product_path(:combo_id => @combo.id), class: 'txt1' %>
    <%= link_to "已拍商品", ims_store_products_path(:combo_id => @combo.id), class: 'txt1' %>
    <%= link_to "从系统选择", ims_store_products_path(:combo_id => @combo.id), class: 'txt1' %>
    <button class="btn btn-large btn-danger btn-block txt1" id="btn-cancel">取消</button>
  </div>

</div>

<%= content_for :javascripts do -%>
<script type="text/javascript" charset="utf-8">
  $(function(){

    $("#combo_form").on("submit", function(){
      var image_fields = $("input[name='image_ids[]']")
      var product_image_fields = $("input[name='product_image_ids[]']")
      verify_image1 = image_fields.length == 0
      verify_image2 = product_image_fields.length < 2
      verify_image3 = product_image_fields.length > 3
      if(verify_image1){
        alert("主图必须有")
      }
      if(verify_image2){
        alert("商品搭配至少要由2个组成")
      }
      if(verify_image3){
        alert("商品搭配最多由3个组成")
      }
      if(verify_image1 || verify_image2 || verify_image3){
        return false
      }

    })

    $("#combo_form").validate({
      rules: {
        "description": {
          required: true,
          minlength: 20,
          maxlength: 128
        }
      },
      errorPlacement:function(error, element){
        element.after(error)
      }
    })

    $("#add a").click(function(){
      $("#add_list").show();
    });


    $("#add_img").click(function(){
       document.getElementById("upfile").click();
    });

    $('#upfile').fileupload({
        url: "/ims/store/combos/<%= @combo.id %>/add_img",
        type: 'get',
        dataType: 'json',

        fileuploadfail: function(e, data){
          alert(e);
        },
        fileuploadchunkfail: function(e, data){
          alert(e);
        },
        done: function(e, data){
          if(data.result['status'] == 1){
            $("#img_box").prepend("<li><i id='img_"+data.result['id']+"' data='"+data.result['id']+"'></i><img src='"+data.result['img']+"'></li>");
            $("#default_img").addClass("show-imgbox-yes");
            $("#default_img").removeClass("show-imgbox-no");
            $("#default_img").html("<img src='"+data.result['img']+"'>");
          }else{
            alert("网络错误，请稍后重试");
          }

        }
       });

      $("#img_box li").click(function(){
        src = $(this).find("img")[0].src;        
        $("#default_img").html("<img src='"+src+"'>");
      });

     $(document).on("click", "#img_box li i", function(){
       mid = $(this).attr("data");
       $.ajax({
        url: "/ims/store/combos/remove_img?img_id="+mid,
        success: function(response){
            $("#img_"+mid).parent().remove();
        }
       });
      
     });   

     $("#add_product").click(function(){
       $("#pop-menu").show();
     });

     $("#btn-cancel").click(function(){
       $("#pop-menu").hide();
     });

     $(document).on("click", "#p_box li i", function(){
       mid = $(this).attr("data");
       $.ajax({
        url: "/ims/store/combos/remove_product?product_id="+mid,
        success: function(response){
            $("#p_"+mid).parent().remove();
        }
       });
      
     });   


    
  });
</script>
<% end -%>
