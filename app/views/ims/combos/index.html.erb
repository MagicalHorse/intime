<%= stylesheet_link_tag "ims/slidernav", :media => "all" %>
<%= javascript_include_tag 'ims/slidernav' %>

<% if nil %>
<div class="wrap-content">
  <div class="module module-white">
    <div class="module-tab0 module-tab2 module-product tabs-fixed">
      <ul id="myTab" class="nav nav-tabs" style="z-index: 100;">
        <li style="border-right: 3px #f16498 solid; position: relative">
          <% if @store %>
          <a href="javascript:void(0)"><%= @store["name"] %></a>
          <% else %>
          <%= select_tag "store", options_from_collection_for_select(@stores, "id", "name"), style: "opacity: 0.01; position: absolute; left: 0; top: 0; width: 100%; height: 100%;" %>
          <a href="javascript:void(0)" id="store_selcet">门店 &nbsp&nbsp<i class="fa fa-chevron-down"></i></a>
          <% end %>
        </li>
        <li style="position: relative">
          <a href="javascript:void(0)" id="brand_selcet">品牌 &nbsp&nbsp<i class="fa fa-chevron-down"></i></a>
        </li>
      </ul>
    </div>
  </div>
</div>
<% end %>

<div class="wrap-inner search_combo_wrap_inner" id="content">

  <div id="search_combo" class="module module-searchinput">
    <div class="row-fluid">
      <div class="span12">
        <%= form_tag ims_combos_path, class: "search-form-defined", id: "search_combo_form", method: "get" do %>
          <div class="controls-defined defined-small">
            <% if @default_store.blank? %>
              <div class="col-3">
                <%= select_tag "store_id", options_for_select(@stores.collect{|store| [store["name"], store["id"]]}, @store.try(:[], :id)), prompt: "选择店铺", style: "opacity: 0.01; position: absolute; left: 0; top: 0; width: 25%; height: 100%;" %>
                <a href="javascript:void(0)" id="store_selcet" class="btn btn-danger btn-small btn-block">筛选</i></a>
              </div>
            <% else %>
              <%= hidden_field_tag "default_store_id", @default_store["id"] %>
            <% end %>

            <div class="<%= @default_store.blank? ? 'col-7' : 'col-10' %>">
              <%= text_field_tag "keywords", params["keywords"], placeholder: "输入品牌、店铺昵称" %>
            </div>

            <div class="col-2">
              <button class="btn btn-danger btn-small btn-block search_combo_button" type="button">搜索</button>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%= render 'ims/shared/countdown' %>

  <% if @combos.count == 0 %>
  <%= render 'ims/shared/empty' %>
  <% else %>
  <%= render 'list' %>
  <div id="loading" class="text-center"></div>
  <% end %>
  <div class="intime-btm intime-btm-index">
    <%= image_tag "ims/intime-btm.png" %>
  </div>
</div>

<% if nil %>
<div class="">
  <div id="store_slider" style="margin-top: 30px; display:none">
    <div class="slider-content">
      <ul style="margin: 0;">
        <% ('a'..'z').each do |char| %>
        <li id="<%= char %>"><a name="<%= char %>" class="title"><%= char.upcase %></a>
          <ul>
            <% @stores_ordered[char].each do |store| %>
            <li><a href="javascript:void(0)" onclick="redirectTo('<%= "/ims/combos?store_id=#{store.id}" %>')"><%= store.name %></a></li>
            <% end %>
          </ul>
        </li>
        <% end %>
      </ul>
    </div>
  </div>

  <div id="brand_slider" style="margin-top: 30px; display:none">
    <div class="slider-content">
      <ul style="margin: 0;">
        <% ('a'..'z').each do |char| %>
        <li id="<%= char %>"><a name="<%= char %>" class="title"><%= char.upcase %></a>
          <ul>
            <% @brands_ordered[char].each do |brand| %>
            <li><a href="javascript:void(0)" onclick="redirectTo('<%= "/ims/combos?brand_id=#{brand.id}&default_store_id=#{params[:default_store_id]}" %>')"><%= brand.name %></a></li>
            <% end %>
          </ul>
        </li>
        <% end %>
      </ul>
    </div>
  </div>
</div>
<% end %>


<%= hidden_field_tag "count", @search[:count] %>
<%= hidden_field_tag "page", @search[:page] %>
<%= hidden_field_tag "per_page", @search[:per_page] %>

<script type="text/javascript">

  $(".select_store_id").on("click", function(){
    $("#store_id").trigger("click")
  })

  $("#store_id").on("change", function(data){
    $("#loading-box").modal();
    setTimeout(function(){
      $("#search_combo_form").submit()
    }, 1)
  })

  $(".search_combo_button").on("click", function(data){
    $("#loading-box").modal();
    setTimeout(function(){
      $("#search_combo_form").submit()
    }, 1)
  })

  function redirectTo(url){
    $("#loading-box").modal();
    setTimeout(function(){
      window.location.href = url;
    }, 1)
  }

  $("#store").click(function(){
    $("#content").show();
    $("#brand_slider").hide();
  })

  $("#store").change(function(){
    window.location.href = "/ims/combos?store_id=" + $(this).val();
  })

  $("#brand_selcet").click(function(){
    if($("#brand_slider").is(":hidden")){
      $("#content").hide();
      $("#store_slider").hide();
      $("#brand_slider").show();
    }else{
      $("#content").show();
      $("#brand_slider").hide();
      $("#store_slider").hide();
    }
  })

  $(document).ready(function(){
    var height = document.body.offsetHeight - 30;
    if(height < 565){ height = 565; }
    $('#store_slider').sliderNav({arrows: false, height: height});
    $('#brand_slider').sliderNav({arrows: false, height: height});
  });


  $(window).scroll(function(){
    var htmlHeight=document.body.scrollHeight
    var clientHeight=document.body.clientHeight
    var scrollTop=document.body.scrollTop
    var count = parseInt($("#count").attr("value"))
    var page = parseInt($("#page").attr("value"))
    var per_page = parseInt($("#per_page").attr("value"))


    if(scrollTop+clientHeight == htmlHeight){
      if(page * per_page < count){
        $("#loading").html('<%= image_tag "ims/loading.gif" %>');
        $.get("<%= request.url %>", {page: page + 1, per_page: per_page}, function(data){
          if(data["status"] == true){
            $(".paginate-content:last").after(data["html"])
            $("#count").attr("value", data["count"])
            $("#page").attr("value", data["page"])
            $("#per_page").attr("value", data["per_page"])
            $("#loading").html("");
          }
        }, "json")
      }
    }

  })

</script>


<script type="text/javascript">

  document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
      // 发送给好友
      WeixinJSBridge.on('menu:share:appmessage', function (argv) {
          WeixinJSBridge.invoke('sendAppMessage', {
              "img_url": "<%= @share_img_url %>",
              "link": "<%= request.url %>",
              "desc":  "<%= @share_desc %>",
              "title": "<%= @share_title %>"
          }, function (res) {
              _report('send_msg', res.err_msg);
          })
      });

      // 分享到朋友圈
      WeixinJSBridge.on('menu:share:timeline', function (argv) {
          WeixinJSBridge.invoke('shareTimeline', {
              "img_url": "<%= @share_img_url %>",
              "link": "<%= request.url %>",
              "desc":  "",
              "title": "<%= @share_desc %>"
          }, function (res) {
              _report('timeline', res.err_msg);
          });
      });
  }, false)
</script>
