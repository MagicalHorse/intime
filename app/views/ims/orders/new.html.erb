<%= form_tag ims_orders_path, id: "new_order" do %>
  <%= image_tag "/images/1.jpg" %>
  D&G女士休闲鞋-0123423123
  微信价: ￥239.00
  品牌价: ￥478.00
  尺码: <%= select_tag "size_id", options_for_select(["", "尺码1", "尺码2"]) %>
  <%= hidden_field_tag "name" %>
  <%= hidden_field_tag "zip_code" %>
  <%= hidden_field_tag "address" %>
  <%= hidden_field_tag "contact" %>
  <%= hidden_field_tag "open_id", session[:wx_openid] %>
  <%= link_to "请点击选择地址", "javascript:void(0);" %>


  <%= link_to "微信安全支付", "javascript:void(0);", id: "save_order" %>
<% end %>

<% content_for :javascripts do %>
<script>
  $(function(){

    var validator = $("#new_order").validate({
      rules: {
        "size_id": {
          required: true
        }
      },
      errorPlacement:function(error, element){
        element.after(error)
      }
    })

    $("#save_order").on("click", function(){
      var this_ele = $(this)
      var form = this_ele.parents("form")
      if($("#new_order").valid()){
        form.ajaxSubmit({
          dataType: "json",
          success: function(data){
            if(data["status"] == true){
              order_id = data["id"]
              if(confirm("是否支付成功？")){
                document.location.href = "/ims/orders/"+order_id
              }else{
                document.location.href = "/ims/orders/"+order_id+"/payments"
              }
            }else{
              alert("提交订单失败")
              // $.each(data["error_messages"], function(index, data){
              //   $(".errore-box .alert").append("<div>"+data+"</div>")
              // })
            }
          },
          error: function(data){
            alert("提交订单发生错误")
          }
        })
      }
    })

    document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
      WeixinJSBridge.invoke('editAddress',{
        appId: "<%= Settings.wx.appid %>",
        scope: "jsapi_address",
        signType: "sha1",
        addrSign: "<%= @addrSign_val %>",
        timeStamp: "<%= @timeStamp_val %>",
        nonceStr: "<%= @nonceStr_val %>"
      },function(res){
        for(var name in res){
          if(typeof res[name] !== 'function'){document.writeln(name+"+:+"+res[name]);}
        }
      //若 res 中所带的返回值不为空，则表示用户选择该返回值作为收货地址。否则若返回空，则表示用户取消了这一次编辑收货地址。
        status = res.err_msg
        if(status["edit_address"] == "ok"){
          name = res.userName
          zip_code = res.addressPostalCode
          address = [res.proviceFirstStageName, res.addressCitySecondStageName, res.addressCountiesThirdStageName, res.addressDetailInfo].join(" ")
          contact = res.telNumber
          $("#name").attr("value", name)
          $("#zip_code").attr("value", zip_code)
          $("#address").attr("value", address)
          $("#contact").attr("value", contact)
        }else{
          alert("获取地址失败")
        }
      })
    })
  })
</script>
<% end %>